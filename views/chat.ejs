<!DOCTYPE html>


<html>
        <head>
                <meta charset="utf-8">
                <title>chat</title>
        </head>
        <body>
            <form onsubmit="return enterName();">
                <input id="name" placeholder="name">
                <input type="submit">
            </form>
            <ul id="users"></ul>

            <form onsubmit="return sendMessage();">
                <input id="message" placeholder="write message">
                <input type="submit">
            </form>

            <ul id="messages"></ul>
        </body>
            <script>
                /******crreate an instant connection******/
                    var io = io("http://localhost:3000");

                    var receiver = "";
                    var sender = "";

                    function enterName(){
                        var name = document.getElementById("name").value

                        /******send name to server******/
                        io.emit("user_connected", name);

                        /******save the name in global variables******/
                        sender = name;

                        /******prevent the form from submitting******/
                        return false;
                    }

                    io.on("user_connected", function (username){
                        var html  = "";
                        html += "<li><button onclick='onUserSelected(this.innerHTML)'" + username + "</button></li>";

                        document.getElementById("users").innerHTML += html;
                    });

                    function onUserSelected(username){
                        /******save user in global variables******/
                        receiver = username;

                        //call an ajax
                        $.ajax({
                            url: "http://localhost:3000/get_messages",
                            method: "POST",
                            data:{
                                sender: sender,
                                receiver: receiver
                            },
                            success: function(response){
                                console.log(response);

                                var messages = JSON.parse(response);
                                var html = "";

                                for (var a = 0; a < mesagges.length; a++){
                                    html += "<li>" + messages[a].sender + message[a].message + "</li>";
                                }

                                //append in list
                                document.getElementById("messages").innerHTML += html;
                            }
                        })
                    }

                    function sendMessage(){
                        /******get message from the user******/
                        var message = document.getElementById("message").valuel;

                        /******send message to server******/
                        io.emit("send_messages", {
                            sender: receiver,
                            message: message
                        });

                        var html = "";
                            html += "<li>" + message + "</li>";

                            document.getElementById("messages").innerHTML += html;

                        /*******don't submit*******/
                        return false;

                        //listen from server

                        io.on("new_message", function(data){
                            var html = "";
                            html += "<li>" + data.sender + data.message + "</li>";

                            document.getElementById("messages").innerHTML += html;
                        });
                    }
            </script>
</html>